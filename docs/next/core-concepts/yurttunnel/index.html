<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenYurt RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenYurt Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="OpenYurt" href="/opensearch.xml">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" color="#ffffff" href="/favicons/safari-pinned-tab.svg">
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-config" content="/favicons/browserconfig.xml"><title data-react-helmet="true">YurtTunnel | OpenYurt</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://openyurt.io/docs/next/core-concepts/yurttunnel"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="YurtTunnel | OpenYurt"><meta data-react-helmet="true" name="description" content="1. Background"><meta data-react-helmet="true" property="og:description" content="1. Background"><link data-react-helmet="true" rel="shortcut icon" href="/img/openyurt.ico"><link data-react-helmet="true" rel="canonical" href="https://openyurt.io/docs/next/core-concepts/yurttunnel"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/docs/next/core-concepts/yurttunnel" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/zh/docs/next/core-concepts/yurttunnel" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://openyurt.io/docs/next/core-concepts/yurttunnel" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.8a5667f5.css">
<link rel="preload" href="/assets/js/runtime~main.6e7eb5b3.js" as="script">
<link rel="preload" href="/assets/js/main.a8318200.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><div class="announcementBar_axC9" role="banner"><div class="announcementBarPlaceholder_xYHE"></div><div class="announcementBarContent_6uhP">⭐️ If you like OpenYurt, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/openyurtio/openyurt">GitHub</a>! ⭐️</div><button type="button" class="clean-btn close announcementBarClose_A3A1" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/openyurt.ico" alt="OpenYurt" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">OpenYurt</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="http://47.243.253.79/login" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Experience-Center<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link" href="/docs/next/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/next/core-concepts/yurttunnel">Next</a></li><li><a class="dropdown__link" href="/docs/core-concepts/yurttunnel">v0.7.0</a></li><li><a class="dropdown__link" href="/docs/v0.6.0/core-concepts/yurttunnel">v0.6.0</a></li><li><a class="dropdown__link" href="/docs/v0.5.0/core-concepts/yurttunnel">v0.5.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/next/core-concepts/yurttunnel" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh/docs/next/core-concepts/yurttunnel" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist" href="#">Getting Started</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Usage Conditions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Installation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Core Concepts</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Components</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/raven">Raven</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/yurthub">YurtHub</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/next/core-concepts/yurttunnel">YurtTunnel</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/yurt-app-manager">YurtAppManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/yurt-controller-manager">YurtControllerManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/node-resource-manager">NodeResourceManager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/core-concepts/yurt-device-controller">YurtDeviceController</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Manuals</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist" href="#">Best Practices</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/next/best-practices/practices-1">Cloud-Edge-Device DevOps Collaboration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Developer Manuals</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/next/faq">FAQ</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->OpenYurt<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/core-concepts/yurttunnel">latest version</a></b> (<!-- -->v0.7.0<!-- -->).</div></div><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->Next</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>YurtTunnel</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="1-background">1. Background<a aria-hidden="true" class="hash-link" href="#1-background" title="Direct link to heading">​</a></h2><p>During application deployment and maintenance, users often need to obtain application logs, or directly log in to the running environment of the application for debugging. In Kubernetes cluster, we usually use <code>kubectl log</code>, <code>kubectl exec</code> and other command to debug. As following picture, on <code>kubelet</code> will act as a server, responsible for processing requests forwarded by <code>kube-apiserver</code> (KAS), which requires a network path between <code>KAS</code> and <code>kubelet</code> to allow <code>KAS</code> to actively access <code>kubelet</code>.</p><p><img alt="img" src="/assets/images/kubectl-4a135b776e4058dae26cb98067a28d99.jpg"></p><p>Cloud and edge are in different network domains, and edge nodes are inside the firewall. The cloud (center) edge collaborative architecture will lead to the following challenges in the maintenance monitoring capabilities of the native K8s system:</p><ul><li>K8s native maintenance capabilities are lacking (such as <code>kubectl logs/exec</code> cannot be executed)</li><li>Community monitoring maintenance components cannot work (such as Prometheus/metrics-server)</li></ul><p>In order to support the maintenance of edge applications through cloud nodes, we must establish a reverse maintenance tunnel between the cloud and the edge.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="2-reverse-tunnel">2. Reverse Tunnel<a aria-hidden="true" class="hash-link" href="#2-reverse-tunnel" title="Direct link to heading">​</a></h2><p>In <code>OpenYurt</code>, we introduced a special component <code>YurtTunnel</code> to deal with the cloud-side communication. <code>Reverse tunnel</code> is a common way to solve cross-network communication, and <code>YurtTunnel</code> is also a <code>reverse tunnel</code>. It is a typical C/S structure component, consisting of <code>Yurt-Tunnel-Server</code> deployed in the cloud and <code>Yurt-Tunnel-Agent</code> deployed on edge nodes. The deployment structure of YurtTunnel is following picture. The whole workflow of the <code>reverse tunnel</code> has the following steps:</p><ul><li>Deploy <code>Yurt-Tunnel-Server</code> on the management and control network plane.</li><li><code>Yurt-Tunnel-Server</code> opens an IP accessible from the public network.</li><li>Deploy a <code>Yurt-Tunnel-Agent</code> on each edge node, and establish a long connection with the Server through the Server&#x27;s public IP.</li><li>Access requests from the management and control components to edge nodes will be forwarded to <code>Yurt-Tunnel-Server</code>.</li><li><code>Yurt-Tunnel-Server</code> sends the request to the target node through the long connection.</li></ul><p><img alt="img" src="/assets/images/tunnel_arch-f5523df0a26022bbc4a94960802f2c40.jpg"></p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="3-implementation">3. Implementation<a aria-hidden="true" class="hash-link" href="#3-implementation" title="Direct link to heading">​</a></h2><p>To create a secure, non-intrusive, and scalable reverse tunnel in the K8s cloud-edge architecture, it needs to include at least the following three capabilities.</p><ul><li>Tunnel</li><li>Self-management of certificates at both ends of the tunnel</li><li>Cloud component requests are diverted to the tunnel</li></ul><p>Architecture of <code>YurtTunnel</code> is as follows:</p><p><img alt="img" src="/assets/images/tunnel_components-98b2297c73ddbafee663f1dacf5ec19d.jpg"></p><p>1) Tunnel</p><p>When the <code>Yurt-Tunnel-Agent</code> on the edge starts up, it will establish a connection and register with the <code>Yurt-Tunnel-Server</code> according to the access address, and periodically check the health status of the connection and rebuild the connection.</p><p><code>Yurt-Tunnel-Agent</code> registered is as follows：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;agentID&quot;: {NodeName}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;agentIdentifiers&quot;: ipv4={nodeIP}&amp;host={NodeName}&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>When <code>Yurt-Tunnel-Server</code> receives a request from a cloud component, it needs to forward the request to the <code>Yurt-Tunnel-Agent</code>. Because in addition to forwarding the request, the <code>session</code> is followed by data return or continuous data forwarding (such as <code>kubectl exec</code> ). So it is necessary to forward data in both directions. At the same time, it is necessary to support concurrent forwarding of requests from cloud components, which means that an unique ID needs to be established for each request life cycle. So there are two designs.</li></ul><p>Option 1: The initial cloud-side connection only informs the forwarding request, and <code>Yurt-Tunnel-Agent</code> will establish a new connection with the cloud to process the request. Through the new connection, the problem of requesting unique ID can be resolved, and concurrency can also be resolved. But a connection needs to be established for each request, which will consume a lot of resources.</p><p>Option 2: Only the initial cloud-edge connection is used to forward requests. In order to reuse the same connection for a large number of requests, it is necessary to encapsulate each request and add an unique ID to solve the concurrent forwarding. At the same time, since a connection needs to be reused, it is necessary to decouple connection management and request lifecycle management. That is to manage the transition of request forwarding. This option involves packet and unpacket, request processing state machine, etc. The option will be a little more complicated.</p><ul><li>The <code>ANP</code> component selected by OpenYurt adapts the above option 2, which also satisfies our original design intention.</li><li>Request forwarding is encapsulated in <code>Packet_DialRequest</code> and <code>Packet_DialResponse</code>, where <code>Packet_DialResponse.ConnectID</code> is used to identify <code>request</code>, which is like <code>requestID</code> in <code>tunnel</code>. The request and data are encapsulated in <code>Packet_Data</code>. <code>Packet_CloseRequest</code> and <code>Packet_CloseResponse</code> are used to forward and recycle resource. For details, please refer to the following sequence diagram:</li></ul><p><img alt="img" src="/assets/images/tunnel_sequence_diag-385d8a83150e7246026538e7948dd738.jpg"></p><ul><li><p><code>RequestInterceptor</code> module</p><p> It can be seen from the above analysis that before <code>Yurt-Tunnel-Server</code> forwards the request, the client needs to make an <code>Http Connect</code> request to create a forwarding path. However, it is difficult to do some work for open source components such as <code>Prometheus</code> and <code>metrics-server</code>. Therefore, a request hijacking module <code>Interceptor</code> is added to <code>Yurt-Tunnel-Server</code> to make <code>Http Connect</code> requests.</p></li></ul><p>2) Certificate management</p><p>In order to keep long and secure communication of cloud-edge, and also to support https request forwarding, <code>YurtTunnel</code> needs to generate its own certificate and maintain the automatic rotation of the certificate. The details are as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><pre tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 1. Yurt-Tunnel-Server certificate:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/pki/certmanager/certmanager.go#L45-90</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- certificate path: /var/lib/yurt-tunnel-server/pki</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;kube-apiserver-kubelet-client&quot;  // webhook validation for kubelet server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;system:masters&quot;, &quot;openyurt:yurttunnel&quot;} // webhook validation for kubelet server and auto approve for Yurt-Tunnel-Server certificate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Subject Alternate Name values: {x-tunnel-server-svc, x-tunnel-server-internal-svc&#x27;s ips and dns names}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: &quot;any&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 2. Yurt-Tunnel-Agent certificate：</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/pki/certmanager/certmanager.go#L94-112</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- certificate path: /var/lib/yurt-tunnel-agent/pki</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- CommonName: &quot;yurttunnel-agent&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Organization: {&quot;openyurt:yurttunnel&quot;} // auto approve for Yurt-Tunnel-Server certificate</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- Subject Alternate Name values: {NodeName, nodeIP}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- KeyUsage: &quot;any&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 3. Yurt-tunnel Certificate Signing Request (CSR) is approved by Yurt-Tunnel-Server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/pki/certmanager/csrapprover.go#L115</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- watch csr resource</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- filter non yurt-tunnel csr (there is no &quot;openyurt:yurttunnel&quot; in Organization)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- approve unapproved csr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 4. certificate automatic rotation</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/client-go/util/certificate/certificate_manager.go#L224</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>3) transfer cloud component requests to the tunnel</p><p>Because the request of the cloud component needs to be forwarded to the <code>Yurt-Tunnel-Server</code>, it also means that no modification to the cloud component is required. So it is necessary to analyze the requests of cloud components. Currently the maintenance requests of components have the following two types:</p><ul><li>type 1: access using IP address, such as: http://{nodeIP}:{port}/{path}</li><li>type 2: access using domain name, such as: http://{NodeName}:{port}/{path}</li></ul><p>Different solutions need to be adopted for different types of requests.</p><p>Solution 1: Use iptables dnat rules to ensure that type 1 requests are forwarded to <code>Yurt-Tunnel-Server</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># iptables rules code: https://github.com/openyurtio/openyurt/blob/master/pkg/yurttunnel/iptables/iptables.go</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># The iptables dnat rules maintained by Yurt-Tunnel-Server are as follows:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L OUTPUT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* edge tunnel server port */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-10255  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10255 /* jump to port 10255 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-10250  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:10250 /* jump to port 10250 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT-10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            127.0.0.1            /* return request to access node directly */ tcp dpt:10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            172.16.6.156         /* return request to access node directly */ tcp dpt:10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* dnat to tunnel for access node */ tcp dpt:10255 to:172.16.6.156:10264</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Solution 2: Use dns domain name to resolve NodeName as the access address of Yurt-Tunnel-Server, so that type 2 requests can be forwarded to yurt-tunnel. Its working principle is as follows:</p><p><img alt="img" src="/assets/images/tunnel_dns-3f45c486b188e1dd9e5b254ba516e10f.jpg"></p><ul><li><code>Yurt-Tunnel-Server</code> maintains two Service addresses： <ul><li>x-tunnel-server-svc: expose port 10262/10263 used to access from the public networkYurt-Tunnel-Server. Such as Yurt-Tunnel-Agent </li><li>x-tunnel-server-internal-svc: cloud components is accessed from the internal network, such as prometheus, metrics-server</li></ul></li><li><code>Yurt-Tunnel-Server</code> has a DNS Controller, dynamically configures Core DNS Host records, and maintains the mapping relationship between NodeName and IP (Cloud Node is directly reachable according to IP, directly mapped to Node IP; Edge Node needs to communicate through the Tunnel tunnel agent, mapping to the cluster ip of <code>Yurt-Tunnel-Server</code> Internal Service)</li><li>When the cloud component accesses the Edge node through NodeName, it will do domain name resolution through CoreDNS by default, and the request for the Edge Node will be directed to the ClusterIP of the internal service of <code>Yurt-Tunnel-Server</code>, and then use the forwarding ability of kube-proxy to forward the request Load balancing to healthy Yurt-Tunnel-Server Pods</li><li><code>Yurt-Tunnel-Server</code> will check the requested Host. When the Host is NodeName, it will find the correct Agent backend through the node name and forward the data</li></ul><p>4) port extension</p><p>If users need to access other ports on the edge (other than 10250 and 10255), they need to add dnat rules in iptables or add port mapping in x-tunnel-server-internal-svc, as shown following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># For example, access port 9051 of the edge</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add iptables dnat rule:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">TUNNEL-PORT-9051  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:9051 /* jump to port 9051 */</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[root@xxx /]# iptables -nv -t nat -L TUNNEL-PORT-9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            127.0.0.1            /* return request to access node directly */ tcp dpt:9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">RETURN     tcp  --  *      *       0.0.0.0/0            172.16.6.156         /* return request to access node directly */ tcp dpt:9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* dnat to tunnel for access node */ tcp dpt:9051 to:172.16.6.156:10264</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># add port mapping in x-tunnel-server-internal-svc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: https</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 10250</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10263</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: http</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 10255</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10264</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: dnat-9051 # add port mapping</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    port: 9051</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    targetPort: 10264</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above iptables dnat rules and service port mapping are automatically updated by <code>Yurt-Tunnel-Server</code>. Users only need to add port configuration in <code>yurt-tunnel-server-cfg</code> configmap in <code>kube-system</code>. details as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Yaml"><pre tabindex="0" class="prism-code language-Yaml codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># Notice: Due to uncontrollable factors of the certificate, the new port currently only supports forwarding from 10264 of Yurt-Tunnel-Server</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dnat-ports-pair: 9051=10264 # new port = 10264 (non 10264 forwarding is not supported)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  name: yurt-tunnel-server-cfg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  namespace: kube-system</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/openyurtio/openyurt.io/edit/master/docs/core-concepts/yurttunnel.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-07-05T11:19:58.000Z">7/5/2022</time></b> by <b>Cookie</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/next/core-concepts/yurthub"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->YurtHub</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/next/core-concepts/yurt-app-manager"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">YurtAppManager<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-background" class="table-of-contents__link toc-highlight">1. Background</a></li><li><a href="#2-reverse-tunnel" class="table-of-contents__link toc-highlight">2. Reverse Tunnel</a></li><li><a href="#3-implementation" class="table-of-contents__link toc-highlight">3. Implementation</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/installation/summary">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/openyurt/shared_invite/zt-rc5ecz4h-sEWU1vYx5gzc3_zx3En0jg" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CNCF Slack ( #openyurt channel )<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/next/core-concepts/">DingTalk (31993519)</a></li><li class="footer__item"><a href="https://shimo.im/docs/rGK3cXYWYkPrvWp8" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Bi-week Meeting (APAC, Chinese)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/openyurtio/openyurt" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/openyurtio/community/blob/main/community-membership.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Community Membership<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://47.243.253.79/login" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>OpenYurt Experience Center<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
        <br>
        <strong>Copyright © 2022 The OpenYurt Authors. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage/"> Trademark Usage</a> page.</strong></div></div></div></footer></div>
<script src="/assets/js/runtime~main.6e7eb5b3.js"></script>
<script src="/assets/js/main.a8318200.js"></script>
</body>
</html>